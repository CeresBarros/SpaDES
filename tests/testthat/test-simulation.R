test_that("simulation runs with simInit and spades", {
  on.exit({
    detach("package:magrittr")
    rm(mySim)
  })

  library(magrittr)

  set.seed(42)

  times <- list(start=0.0, stop=10, timestepUnit="year")
  params <- list(
    .globals=list(burnStats="npixelsburned", stackName="landscape"),
    randomLandscapes=list(.plotInitialTime=NA, .plotInterval=NA),
    caribouMovement=list(.plotInitialTime=NA, .plotInterval=NA, torus=TRUE),
    fireSpread=list(.plotInitialTime=NA, .plotInterval=NA)
  )
  modules <- list("randomLandscapes", "caribouMovement", "fireSpread")
  path <- system.file("sampleModules", package="SpaDES")

  mySim <- simInit(times, params, modules, objects=list(), path) %>% spades

  # simtime
  expect_equivalent(time(mySim), 10.0)
  expect_equivalent(start(mySim), 0.0)
  expect_equivalent(end(mySim), 10.0)

  # sim results
  if (identical(environment(), .GlobalEnv)) {
    burnedLast <- c(1680, 1485, 607, 1079, 1041, 605, 871, 1097, 495, 1253)

    pos_x <- c(-36.9964594878183, 2.32458656754471, 30.12442850383, -18.6640229184998,
               -33.8885207519506, -29.5427930908878, -21.0095214973779, -6.42587067738999,
               -5.07663946918247, 1.51100547592112, 40.1425992497513, -40.0937640741396,
               8.4223912961982, -28.2165542018589, -23.0437975158775, 18.294604333076,
               -16.7308043319382, -8.47854059870558, 39.0343113708618, -39.3309621495378,
               -3.85775142502581, 49.0817194947727, -17.9722065247698, 4.55173210595375,
               -41.0519469414064, 34.8930158926542, -32.589908783801, -40.5387963961559,
               34.2194237750273, -33.5059996554471, 41.7214409962314, -33.4975937591762,
               -16.7534188285129, -3.15227992913145, 23.6589792431533, 28.0041852235432,
               43.3963008307616, 15.6253468583625, -24.338203383424, 38.3698431106254,
               -8.95270144561675, 33.179905218285, -32.412733860245, 35.8000608503506,
               32.1821466587538, -5.44818140354121, 34.3391843159336, -1.11939974258066,
               -29.9411578108715, -8.4957082608383, 38.4884378359319, -44.6014019956853,
               9.52576850503965, -29.621391887535, -3.42226265233396, -48.0427755267367,
               -48.0453925992576, 31.3356691703378, 39.4370108644243, -23.0450600175721,
               -29.9676867807934, -14.984320542406, 13.0752058955144, 11.8531604473534,
               -24.9697318775997, -25.3771063203708, 46.0558653502021, 27.1583913421414,
               47.0730137699115, -43.2589915711839, 34.287440364578, -16.462781379318,
               13.8025952614028, 7.98145114328579, 12.6617467700004, 8.6529212125842,
               42.9266926532228, -29.6405295858366, 35.0331975539472, 22.782823127803,
               -33.6543726032234, -9.20996524772551, 6.86344094726754, -42.0192917407262,
               41.097913592971, 9.11335978963641, 35.7427369785196, 1.39434498353882,
               25.6514918771879, -25.7249927901813, 46.5803504144238, -46.9702484362805,
               30.3177776221904, 11.1446124689632, 46.5656200410542, 42.6072217133873,
               -26.5944387764709, 30.3706355061775, -39.2953280003378, -6.61414387806415)

    pos_y <- c(11.2259177001642, -48.2749285467045, -19.2693150119305, -30.1955629122566,
               -5.16274098908813, 19.7263653977621, -18.3682115225133, 11.738367415035,
               38.9967732966357, 2.71795967614925, -44.7225009655404, -32.6275290676451,
               -14.7686749801842, 25.2266058813999, 43.367709252435, 40.625866000042,
               22.0714768248821, -24.1975134747756, -24.2623383782744, -12.5286480447744,
               48.122230154392, -44.8308278925359, 37.0642433839201, -15.6006743461834,
               -28.265637676497, 8.5281444890346, 37.3382373812721, 30.2225238433243,
               -26.9394661142134, 29.4716759594875, -43.5670094907836, -47.8084247612384,
               -48.1749534451242, -45.1487680482165, -30.8568223487393, -39.0221779181183,
               -15.806612632621, 9.37725216531152, -40.2347020337625, 19.3362330671687,
               10.0653991235251, -24.599586469326, -35.8913143320209, 35.6277170387067,
               35.5608652339012, -36.7887704649442, -5.75447090913782, 1.01447582952702,
               12.9836719196659, -18.5773516046411, -46.6496786531966, -22.4229092556123,
               35.9359685267436, 45.2300691122058, 25.6432668008571, 41.3834115900633,
               -13.4068360644368, -26.1410488438946, -47.4071373813623, -32.2387795954974,
               -35.7842792759393, -7.70426791095162, 36.0018667789867, 30.1562830869532,
               41.6895906080711, 47.8520336608373, 3.57737369062482, -39.6190773865091,
               5.37402201117737, -37.3107079155598, -34.1742440396536, -19.2538176414933,
               -48.6308373737092, -26.392445100473, -41.039612082825, -46.6119580572095,
               -16.844154891972, -26.0741751607543, -31.4374762519959, -6.44047912640615,
               44.8723281786276, -43.6527354527293, 37.8112535875202, -22.5498526193275,
               25.9669403382768, 1.16676526552681, -30.6497237706147, 32.5573215765397,
               15.4977777956788, 20.7609180017956, 31.0985715416653, -34.7622261504206,
               18.6274139594293, 43.0727309557879, -18.0134694585456, 39.5790564364162,
               12.5097325118235, -31.4932896470479, 37.7529892755605, -30.960625150814)

  } else {

    burnedLast <- c(785, 1541, 1673, 1296, 1705, 631, 911, 2296, 194, 891)

    pos_x <- c(24.2484686483964, 47.8128860747824, -42.2542901484232, -49.6076585950946,
               -2.08758253657705, 43.600130501776, -47.8565931427708, 3.37707426482672,
               -30.2337064315568, 48.327542771926, -28.3116175085039, 36.0293427893222,
               -32.0650350082341, -37.0807465035526, 8.8523786501825, 9.6663888111089,
               42.0391946866896, 33.7509815350234, 5.19714969246581, 46.9356738702195,
               25.3952717813589, 49.5569969069648, 33.3009011102963, 16.7072871607162,
               -38.1630915528689, 42.9564425808665, -19.1064055622212, -45.9588358034656,
               37.761035390674, -46.0741187826306, -45.8497121335815, 17.3369197246193,
               40.395160938502, 47.6390870734854, -22.8430512900071, -45.6616044599655,
               -46.198650370821, 7.729969747414, -37.3757347717149, 46.2664171353822,
               18.1313373804038, 36.7641638545354, 48.6937167159994, 42.5450614766255,
               -35.4451551557847, -48.7928948167036, -44.0094840611286, 21.837706039553,
               -3.6700624966722, 34.9989230500494, -42.8008629386155, 5.94154144598043,
               3.20724021469886, -34.26850167122, -45.7457138127418, 37.5257558063073,
               44.2468659724348, 27.6041183043826, 9.02936153159189, 14.7318271257455,
               -19.6786089114154, 41.1892852134569, 40.5485069015152, -24.9717521287956,
               44.1135575886761, 41.5407605796235, 26.2978783394587, -36.8577203496523,
               44.0720843346254, -32.8014265722868, 31.9745943344497, 38.3984445137168,
               6.22844858120903, -20.4386364758736, 6.32892159579568, -17.4149893085045,
               9.28564338314425, -39.2976064567272, 48.5449746481372, -46.9435864646656,
               31.9389693544616, -4.08377610256061, -46.4725043375814, -23.0472664140462,
               8.1673436310303, 14.8318499520262, -41.4469113291788, 43.8166677736944,
               -18.6839366657156, -38.2035328594829, -14.8637022937274, 30.0652355962356,
               27.7730175631119, 41.0675990724293, 18.2151784571115, 29.2217910496471,
               45.3822181047359, 33.2757577695366, 33.5354441756044, -25.5439023778461)

      pos_y <- c(-13.2775352686745, -15.1921400405611, -37.4645624975847, 14.2001282474005,
                 49.3331977527288, 13.2442206966891, -2.28637853874899, -38.6209519599604,
                 -42.7564858603457, -1.48323118493274, -46.2240562958294, -19.5068244713051,
                 -42.8763947856156, 46.482168788281, -13.533974776063, 46.9325211086457,
                 32.4782920378475, -49.6792227117399, -40.6844990822202, -39.7712187749804,
                 46.7934263068862, 20.8929541380157, 11.3745541879864, -24.1095420042339,
                 -49.4806038339298, 6.63256219975469, -16.4770808795865, -3.98351451731607,
                 4.35854414760173, -8.84199139013204, 34.2138317088839, 11.006859440822,
                 -26.8334823199429, 6.17610641971436, -31.2786104621111, -6.36003667653415,
                 -4.21678779143281, 42.1619086129274, 45.0357497565028, 44.1951756358799,
                 9.73209188824214, 21.9792087520938, 16.4174597226726, 0.428676444204413,
                 8.0185011778249, -9.53367546387447, -25.1286943036342, 46.9439198656238,
                 -39.0523489542367, 7.04386379488403, 25.1292815265792, -18.7937866083131,
                 -39.2389314000086, 17.7574961545963, 33.3616040013765, -17.5414820343468,
                 -37.2725217531662, -13.626989492748, -26.1618431705542, -29.1134323305541,
                 -20.960022890503, -38.7909156482694, 7.58906720077477, 5.98781665842886,
                 32.3536312889388, -5.17051919333881, 40.3228724564757, -49.4269057575967,
                 -46.6866522327586, 25.3285091048393, -36.5877253794136, 49.4820039456389,
                 -21.9121419998056, 47.1337969103822, 39.1251571889775, -13.2778097942367,
                 -30.8777787342624, -22.5161696158985, -36.9356288127596, 44.4565040727072,
                 32.1353078416919, -23.4566170169242, 24.1469094454914, -43.2868549766288,
                 28.8620548889279, -14.5957241519371, -2.88601404417302, 8.8019980069604,
                 -28.9009945634525, -42.1928331815034, 37.6542700563508, -30.6569914653233,
                 -32.6842290694728, 21.0590765480462, -20.4388674672974, -21.4226298348291,
                 -33.6977866710156, 23.4840916288445, 39.0646623878697, 45.0662374517899)
  }

  print(cbind(mySim$npixelsburned, burnedLast))
  print(tail(cbind(mySim$caribou$x, pos_x)), 20)
  print(tail(cbind(mySim$caribou$y, pos_y)), 20)

  #expect_equal(mySim$npixelsburned, burnedLast)
  #expect_equivalent(mySim$caribou$x, pos_x)
  #expect_equivalent(mySim$caribou$y, pos_y)
})
