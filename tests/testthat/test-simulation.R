test_that("simulation runs with simInit and spades", {
  library(igraph); on.exit(detach("package:igraph"))

  set.seed(42)

  times <- list(start = 0.0, end = 10, timeunit = "year")
  params <- list(
    .globals = list(burnStats = "npixelsburned", stackName = "landscape"),
    randomLandscapes = list(.plotInitialTime = NA, .plotInterval = NA),
    caribouMovement = list(.plotInitialTime = NA, .plotInterval = NA, torus = TRUE),
    fireSpread = list(.plotInitialTime = NA, .plotInterval = NA)
  )
  modules <- list("randomLandscapes", "caribouMovement", "fireSpread")
  paths <- list(modulePath = system.file("sampleModules", package = "SpaDES"))

  mySim <- simInit(times, params, modules, objects = list(), paths) %>% spades()

  # simtime
  expect_equivalent(time(mySim), 10.0)
  expect_equivalent(start(mySim), 0.0)
  expect_equivalent(end(mySim), 10.0)

  # sim results ## NOTE upcoming version of RandomFields completely changes the values!!!
  if (packageVersion('RandomFields') >= "3.1.20") {
    burnedLast <- c(1503, 504, 672, 1580, 1403, 1403, 1321, 685, 589, 1889)

    pos_x <- c(
      30.2146312306235, 27.6741891467258, 45.7601411305629, -1.61750646089505,
      -19.9280136700568, 24.0837546230219, 0.020280119066129, 33.9783632544531,
      -24.6992513161243, 21.9808725511789, 48.1609765723287, 2.94548815722943,
      34.0643549461297, -2.9884815762966, -35.3329368757272, 18.0724094096275,
      -37.7530751890527, -19.994585520086, 14.5213915707686, -14.6919529003549,
      7.38109752259093, 19.9031838937574, 47.0580826225495, 31.5040223636183,
      -18.698039277128, 39.0533596646147, 4.1613594259351, 5.74668824401759,
      -8.70536967112456, -41.4314340365517, -15.6844778080485, 36.1000910244664,
      38.6335280593608, -17.8880566877968, 39.5274430274659, 0.994472223004927,
      -11.2384514546593, 11.4028707773769, 46.2299005205994, 23.5208508620944,
      -37.2480819063434, 29.9661662814365, 4.12980759323712, 21.302349383256,
      35.5481396181337, -33.1814598279696, 20.3242193232461, 6.22185591510886,
      39.8177507048966, 23.5574887375457, -33.3899118968837, 12.0679435566816,
      18.7996263613804, 16.7612831538075, -21.3625004816711, 31.0658169566744,
      -24.0304736196802, 28.2421106190294, 31.1454713007457, -28.3569509875074,
      11.6729373964879, -48.6095220913341, 46.4990570834919, 10.0805383981042,
      32.1268094630033, -35.2768766565333, -46.7276003755033, -39.5855758677043,
      37.995064346472, 25.2338293678144, -8.754085879657, -41.0550560148692,
      -21.0727397035555, 15.8433159362077, -20.3460345963446, -0.546602871094798,
      6.31459286758618, -37.9903016154296, -37.4763557245733, -17.2006588223272,
      30.1418992300913, 32.1647080130352, -36.0918014647053, 16.0199125708061,
      47.0653350990421, -38.6785638060647, 32.819105107935, -3.77918596233659,
      -49.4015231150649, -19.719480159172, -49.6624337507667, 11.7224852437135,
      38.4205340077961, 14.99410116009, -30.1641772259344, 13.6307693923657,
      -22.2074608875684, 33.2213346244918, 49.8190373081307, 38.390167684661
    )

    pos_y <- c(
      -14.2499633786252, -19.4950377185342, 21.7721272532114, 5.90288645868783,
      -10.7039498345114, -41.9581570311464, -12.0349558325868, 38.3436387731824,
      38.0875299580277, 11.3143047172959, 33.0440175199102, 35.3421298960594,
      -13.8037962805308, -3.32440405024042, 34.0636822927551, -22.2616049025709,
      10.8461186461595, 39.8075728675783, -0.163323836091905, -38.9216338626274,
      -41.7179041896125, -43.5004834804807, -24.2542720818419, 36.2702100149428,
      39.5812115232149, 30.6412446831226, 15.1041444415704, -35.5510467166105,
      2.79726574678946, -32.0125962156418, -46.076412331816, 19.1935979330279,
      -0.269042394840959, 36.9404571416434, -8.32406374250636, 30.9813323216601,
      -11.3224242254613, 28.1579775020793, 10.1445387648911, 21.4852616544346,
      30.3393447531632, 23.8365099579959, 16.9915210174932, -24.8597593544705,
      -26.0069136445973, -26.7463377684512, -11.4921298523892, 7.88866562042191,
      -46.5778059405297, 5.0568338916652, -43.2594894843514, 3.66919543665666,
      41.4652561900772, 8.65910857733429, 13.8475666464571, 12.6100444191492,
      12.8761928013771, -17.9612208733746, -46.2641661503169, 31.6285145246539,
      30.5924952013655, 14.0502715166704, 39.4173688977672, 49.5354612208264,
      39.5630403287473, -21.0640911483377, 12.4704836907508, 43.319259979239,
      40.8080967827217, 22.6238051244902, -38.1243959319478, -0.603851379659304,
      -27.8976565557061, 34.3936322954244, -36.1584520528631, -5.19446941265629,
      -49.677216442041, -16.7167629024184, -19.5170677016992, 43.078714113604,
      28.0346543488304, 23.6171084190064, 7.95331694186783, -28.2366570229203,
      -47.5434955842431, -42.4743877444356, -34.8122298255382, 42.7444662050693,
      -12.1250518345523, -31.5587590893649, -47.7982062084949, -30.4870240652421,
      -38.5777037589262, 9.89689127220846, 41.0587051419708, -23.1199570951325,
      -24.9503949753543, -22.9574745824328, -40.3045371993524, -7.95992715558874
    )
  } else {
    burnedLast <- c(1680, 1485, 607, 1079, 1041, 605, 871, 1097, 495, 1253)

    pos_x <- c(
      -36.9964594878183, 2.32458656754471, 30.12442850383, -18.6640229184998,
      -33.8885207519506, -29.5427930908878, -21.0095214973779, -6.42587067738999,
      -5.07663946918247, 1.51100547592112, 40.1425992497513, -40.0937640741396,
      8.4223912961982, -28.2165542018589, -23.0437975158775, 18.294604333076,
      -16.7308043319382, -8.47854059870558, 39.0343113708618, -39.3309621495378,
      -3.85775142502581, 49.0817194947727, -17.9722065247698, 4.55173210595375,
      -41.0519469414064, 34.8930158926542, -32.589908783801, -40.5387963961559,
      34.2194237750273, -33.5059996554471, 41.7214409962314, -33.4975937591762,
      -16.7534188285129, -3.15227992913145, 23.6589792431533, 28.0041852235432,
      43.3963008307616, 15.6253468583625, -24.338203383424, 38.3698431106254,
      -8.95270144561675, 33.179905218285, -32.412733860245, 35.8000608503506,
      32.1821466587538, -5.44818140354121, 34.3391843159336, -1.11939974258066,
      -29.9411578108715, -8.4957082608383, 38.4884378359319, -44.6014019956853,
      9.52576850503965, -29.621391887535, -3.42226265233396, -48.0427755267367,
      -48.0453925992576, 31.3356691703378, 39.4370108644243, -23.0450600175721,
      -29.9676867807934, -14.984320542406, 13.0752058955144, 11.8531604473534,
      -24.9697318775997, -25.3771063203708, 46.0558653502021, 27.1583913421414,
      47.0730137699115, -43.2589915711839, 34.287440364578, -16.462781379318,
      13.8025952614028, 7.98145114328579, 12.6617467700004, 8.6529212125842,
      42.9266926532228, -29.6405295858366, 35.0331975539472, 22.782823127803,
      -33.6543726032234, -9.20996524772551, 6.86344094726754, -42.0192917407262,
      41.097913592971, 9.11335978963641, 35.7427369785196, 1.39434498353882,
      25.6514918771879, -25.7249927901813, 46.5803504144238, -46.9702484362805,
      30.3177776221904, 11.1446124689632, 46.5656200410542, 42.6072217133873,
      -26.5944387764709, 30.3706355061775, -39.2953280003378, -6.61414387806415
    )

    pos_y <- c(
      11.2259177001642, -48.2749285467045, -19.2693150119305, -30.1955629122566,
      -5.16274098908813, 19.7263653977621, -18.3682115225133, 11.738367415035,
      38.9967732966357, 2.71795967614925, -44.7225009655404, -32.6275290676451,
      -14.7686749801842, 25.2266058813999, 43.367709252435, 40.625866000042,
      22.0714768248821, -24.1975134747756, -24.2623383782744, -12.5286480447744,
      48.122230154392, -44.8308278925359, 37.0642433839201, -15.6006743461834,
      -28.265637676497, 8.5281444890346, 37.3382373812721, 30.2225238433243,
      -26.9394661142134, 29.4716759594875, -43.5670094907836, -47.8084247612384,
      -48.1749534451242, -45.1487680482165, -30.8568223487393, -39.0221779181183,
      -15.806612632621, 9.37725216531152, -40.2347020337625, 19.3362330671687,
      10.0653991235251, -24.599586469326, -35.8913143320209, 35.6277170387067,
      35.5608652339012, -36.7887704649442, -5.75447090913782, 1.01447582952702,
      12.9836719196659, -18.5773516046411, -46.6496786531966, -22.4229092556123,
      35.9359685267436, 45.2300691122058, 25.6432668008571, 41.3834115900633,
      -13.4068360644368, -26.1410488438946, -47.4071373813623, -32.2387795954974,
      -35.7842792759393, -7.70426791095162, 36.0018667789867, 30.1562830869532,
      41.6895906080711, 47.8520336608373, 3.57737369062482, -39.6190773865091,
      5.37402201117737, -37.3107079155598, -34.1742440396536, -19.2538176414933,
      -48.6308373737092, -26.392445100473, -41.039612082825, -46.6119580572095,
      -16.844154891972, -26.0741751607543, -31.4374762519959, -6.44047912640615,
      44.8723281786276, -43.6527354527293, 37.8112535875202, -22.5498526193275,
      25.9669403382768, 1.16676526552681, -30.6497237706147, 32.5573215765397,
      15.4977777956788, 20.7609180017956, 31.0985715416653, -34.7622261504206,
      18.6274139594293, 43.0727309557879, -18.0134694585456, 39.5790564364162,
      12.5097325118235, -31.4932896470479, 37.7529892755605, -30.960625150814
    )
  }

  expect_equal(mySim$npixelsburned, burnedLast)
  expect_equivalent(mySim$caribou$x, pos_x)
  expect_equivalent(mySim$caribou$y, pos_y)
})

test_that("spades calls with different signatures don't work", {
  tmpdir <- file.path(tempdir(), "test_Plot1") %>% checkPath(create = TRUE)
  cwd <- getwd()
  setwd(tmpdir)

  on.exit({
    setwd(cwd)
    unlink(tmpdir, recursive = TRUE)
    detach("package:igraph")
  })
  library(igraph)

  a <- simInit()
  expect_silent(spades(a))
  expect_output(spades(a, debug = TRUE), "eventTime")
  expect_silent(spades(a, .plotInitialTime = NA))
  expect_silent(spades(a, .saveInitialTime = NA))
  expect_output(spades(a, debug = TRUE, .plotInitialTime = NA), "eventTime")
  expect_output(spades(a, debug = TRUE, .saveInitialTime = NA), "eventTime")
  expect_equivalent(capture_output(spades(a, debug = "current", .plotInitialTime = NA)),
                capture_output(spades(a, debug = TRUE, .plotInitialTime = NA)))

  expect_output(spades(a, debug = c("current", "events"), .plotInitialTime = NA),
                "-------------")
  expect_output(spades(a, debug = "simList", .plotInitialTime = NA),
                "Completed Events")


  if (interactive()) {
    expect_output(spades(a, progress = "text", debug = TRUE), "10%")
    expect_output(spades(a, progress = "text", debug = TRUE), "20%")
    expect_output(spades(a, progress = "text"), "..........| 100%")
  }
  expect_silent(spades(a, progress = FALSE))
  expect_silent(spades(a, progress = "rr"))

  paths(a)$cachePath <- file.path(tempdir(), "cache") %>% checkPath(create = TRUE)
  expect_output(spades(a, cache = TRUE, debug = TRUE), "eventTime")
  expect_true(all(dir(paths(a)$cachePath) == c("backpack.db", "gallery")))
  file.remove(dir(paths(a)$cachePath, full.names = TRUE, recursive = TRUE))

  # test for system time ... in this case, the first time through loop is slow
  #   because of writing cache to disk, not because of spades being slow.
  #   SimList is empty.
  for (i in 1:2) {
    a <- simInit()
    paths(a)$cachePath <- file.path(tempdir(), "cache") %>% checkPath(create = TRUE)
    assign(paste0("st", i), system.time(spades(a, cache = TRUE)))
  }
  expect_gt(st1[1], st2[1])
  file.remove(dir(paths(a)$cachePath, full.names = TRUE, recursive = TRUE))
})
