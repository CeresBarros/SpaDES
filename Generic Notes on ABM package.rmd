ABM - A generic platform for building 
========================================================

1. Data - 
    1. Retrieve from various sources
        1. GADM.org via sp package - administrative boundaries
        1. Ecological data 
            1. Boreal forest extent
               - http://cfs.nrcan.gc.ca/common/boreal.zip
            1. A classified land cover 
                1. LCC05 - Land Cover Classification 2005 (2000 imagery)
                    http://bit.ly/1ujeRE1
                1. EOSD - 25 m resolution exists, also here at 250m: http://cfs.nrcan.gc.ca/common/eosd/Canada_Mosaic_2000_250m_tif.zip  
            1. Fire data
               http://cwfis.cfs.nrcan.gc.ca/datamart/datarequest/nfdbpnt
            1. Age class data
            1. knn Forest Cover
            1. 
            1. Any other
        1. Climate data
            - Past
            - Future projections
                - Downscaled
        1. Weather data
            - daily? monthly? annual?
        1. Geographic data
            1. DEM
            1. Topographic data
            1. Soils
    1. Manipulation
    1. Reprojection for spatial information
    1. Reclassification of categorical data 
        1. lcc05 - forest data

1. Code repository - such as GitHub
    1. Allows sharing
    1. Can be public
    1. Can be hosted privately on own server

1. Calibration of parameters used within simulation models
    1. Pattern Oriented Modeling
        - Take fire data
        - Fit models to estimate
            - Initiation Probability - The number of fires that start per area
            - Fire spread - The spread probability as a function of lakes, tree species, fuels, weather
    1. Curve calibration
    1. 
    
1. Build simulation model


1. STEVE's 9-minute succession model:
    - data sources
        - LCC05
    - states in model
        - veg type
        - age
        - traj
    - processes
        - transition rules
            - f(state, time): eg deciduous until age 90; conifer after 90
        - regeneration
            - state regen
            - assign traj


1. Code style preferences
    - R style guide
        - lowerCamelCase is preferred (first letter always lower case)
        - class/object names: use nouns
        - method/function names: use verbs

```{r}
setwd("C:/shared/data/shared/")
library(rgdal)
library(raster)
```

```{r Boreal Forest Extent, cache = TRUE}
setwd("C:/shared/data/shared/boreal")
boreal <- readOGR(dsn=".", layer = "NABoreal")
```

```{r Load LCC05, fig.width=12, fig.height=10, cache = TRUE}
lcc05 <- raster("C:/shared/data/shared/LandCoverOfCanada2005_V1_4/LCC2005_V1_4a.tif")
plot(lcc05)
# Extract a sensible smaller extent
#ex <- drawExtent()
#lcc05.ex <- crop(lcc05,ex)
```

```{r Load age clases, fig.width=12, fig.height=10, cache=TRUE}
age <- raster("C:/shared/data/shared/age/age.asc")
plot(age)
crs(age)
# Extract a sensible smaller extent
#ex <- drawExtent()
#lcc05.ex <- crop(lcc05,ex)
```

```{r Reclassify LCC to BAM, cache=TRUE}
lccReclass <- structure(list(BAM.Land.Cover.Class.Name = structure(c(2L, 3L, 
5L, 6L, 4L, 9L, 17L, 18L, 16L, 11L, 14L, 12L, 15L, 10L, 13L, 
7L, 1L, 8L), .Label = c("Burns ", "Closed Coniferous ", "Closed Deciduous ", 
"Closed Deciduous Mixed ", "Closed Mature Mixed ", "Closed Young Mixed ", 
"Mixed Forest/Crop ", "Not Used ", "Open Coniferous ", "Open Herb/Grass ", 
"Open Mature Deciduous ", "Open Mixed ", "Open Northern ", "Open Young Deciduous ", 
"Open Young Mixed ", "Poorly Drained ", "Sparse Coniferous ", 
"Sparse Coniferous Shield "), class = "factor"), BAM.Code = c(1, 
2, 3, 4, 5, 6, 8, 9, 10, 11, 12, 14, 15, 17, 21, 26, 33, NA), 
    LCC05.Labels = structure(c(1L, 8L, 11L, 14L, 15L, 16L, 17L, 
    18L, 2L, 3L, 4L, 5L, 6L, 7L, 9L, 10L, 12L, 13L), .Label = c("1", 
    "10,19", "11", "12,16", "14", "15", "17,18", "2", "21,22,23,24,25,30,31,32", 
    "26,27,28,29", "3", "33,34,35", "36,37,38,39", "4", "5", 
    "6,7", "8,13,20", "9"), class = "factor")), .Names = c("BAM.Land.Cover.Class.Name", 
"BAM.Code", "LCC05.Labels"), class = "data.frame", row.names = c(NA, 
-18L))

lcc05Labels <- as.numeric(strsplit(paste(lccReclass$LCC05.Labels,collapse = ","),",")[[1]])

numOldInNew <- sapply(strsplit(unname(sapply(as.character(lccReclass$LCC05.Labels),function(x) x)),","),length)

lcc05Reclass <- cbind(lcc05Labels,rep(lccReclass$BAM.Code,numOldInNew))

lcc05BAM <- reclassify(lcc05,lcc05Reclass)
```


```{r Reclassify LCC to Burnable, cache=TRUE}
BurnableClasses <- rep(0,39)
BurnableClasses[c(1:35)] <- 1
BurnableClassesFromTo = cbind(1:39,BurnableClasses)
lcc05Burnable <- reclassify(lcc05,BurnableClassesFromTo)
plot(lcc05Burnable)
```

```{r Succession Module 1}
    vegMap <- trajObj[ageMap,trajMap]
    vegMap[indStatics] <- valsStatics
```

```{r Aging module}
    ageMap <- pmin(maxAge, ageMap + 1)
```

```{r benchmark data.table vs adjacent fn}
# Shown that data.table lookup is about 10x faster for a wide range of raster sizes
#  and also for a wide range of quantities of loci (from 10 to 1e5)

# Load raster block
lcc05_01<-raster("C:/shared/data/shared/lcc05_small_chunks/grid1_lcc05_ascii.txt")

adj.all.n <- adjacent(lcc05_01,1:ncell(lcc05_01),directions=8)

adj.all <-cbind(as.integer(adj.all.n[,"from"]),as.integer(adj.all.n[,"to"]))
colnames(adj.all) <- c("from","to")

#plot(lcc05_01)

dt1 <- data.table(adj.all)
setkey(dt1,"from")

library(benchmark)
ben <- benchmark(adj1 <- dt1[J(1:1e1)],
adjacent(lcc05_01,1:1e1,directions=8))

print(ben)

    
```
