%\VignetteIndexEntry{introduction}
\documentclass{article}

%%% latex packages
\usepackage{hyperref}
\usepackage[utf8]{inputenc}
\usepackage[usenames,dvipsnames]{xcolor}

\usepackage{lipsum} % for dummy text only

%% change margins to 1" all the way around
\oddsidemargin 0.0in
\evensidemargin 0.0in
\textwidth 6.5in
\headheight 0.0in 
\topmargin 0.0in
\textheight 9.0in

%%% document info
\title{Introduction to \texttt{SpaDES}}

\author{
  Alex M. Chubaty\\
	\small{Natural Resources Canada, Pacific Forestry Centre}\\
	\small{email: \href{mailto:achubaty@nrcan.gc.ca}{achubaty@nrcan.gc.ca}}
	\and
	Eliot McIntire\\
	\small{Natural Resources Canada, Pacific Forestry Centre}\\
	\small{email: \href{mailto:emcintir@nrcan.gc.ca}{emcintir@nrcan.gc.ca}}
}

\usepackage{Sweave}
\begin{document}
\input{introduction-concordance}
 % displays code as entered (no arranging lines)

\maketitle

\tableofcontents

\newpage

\section{Spatial Discrete Event Simulation (SpaDES)}

\paragraph{Requirements}
This packages makes heavy use of the \texttt{raster} and \texttt{sp} packages, so familiarity with these packages and their classes and methods is recommended.

\begin{Schunk}
\begin{Sinput}
> ## for now only while testing, etc.
> OS <- tolower(Sys.info()["sysname"])
> hostname <- gsub(Sys.info()["nodename"],pattern="W-VIC-",replace="")
> if (OS=="windows") {
+     if(pmatch("A105200", hostname, nomatch=FALSE)) {
+         path <- "c:/Eliot/GitHub"
+     } else {
+         path <- "~/GitHub"
+     }
+ } else {
+     path <- "~/Documents/GitHub"
+ }
> #devtools::dev_mode(TRUE)
> devtools::load_all(file.path(path, "SpaDES")) # for development/testing
\end{Sinput}
\begin{Soutput}
Note: no visible binding for global variable 'to' 
Note: no visible global function definition for 'J' 
Note: no visible binding for global variable 'to' 
Note: no visible binding for global variable 'to' 
Note: no visible binding for global variable 'to' 
\end{Soutput}
\begin{Sinput}
> 
> ## 
> #library(SpaDES)
\end{Sinput}
\end{Schunk}


\newpage

\section{SpaDES modules}

\lipsum

\newpage

\section{Working with maps}

\paragraph{A raster map}
Sample map of habitat quality.

\begin{Schunk}
\begin{Sinput}
> # Give dimensions of dummy raster
> nx = 1.3e2
> ny = 1e2
> template = raster(nrows=ny, ncols=nx, xmn=-nx/2, xmx=nx/2, ymn =-ny/2, ymx=ny/2)
> # Make dummy maps for testing of models
> DEM = round(GaussMap(template, scale = 300, var = 0.03, speedup=1), 1)*1000
> Age = round(GaussMap(template, scale = 10, var = 0.1, speedup=1), 1)*20
> Forest_Cover = round(GaussMap(template, scale = 50, var = 1, speedup=1))*10
> Pct_Pine = round(GaussMap(template, scale = 50, var = 1, speedup=1),1)
> # Scale them as needed
> Age = Age/maxValue(Age)*100
> Pct_Pine = Pct_Pine/maxValue(Pct_Pine)*100
> # Make layers that are derived from other layers
> HabitatQuality = (DEM + Forest_Cover*10)/100
> HabitatQuality = HabitatQuality - minValue(HabitatQuality)
> # Stack them into a single stack for plotting
> habitat = stack(list(DEM,Age,Forest_Cover,HabitatQuality,Pct_Pine))
> names(habitat) = c("DEM","Age", "Forest_Cover", "HabitatQuality", "Pct_Pin")
> library(RColorBrewer)
> cols = list(
+   transparent.red=c("#00000000",paste(brewer.pal(8,"Greys"),"66",sep="")[8:1]),
+   grey = brewer.pal(9,"Greys"),
+   spectral = brewer.pal(8,"Spectral"),
+   terrain = rev(terrain.colors(100)),
+   heat = heat.colors(10),
+   topo = topo.colors(10)
+   )
> simPlot(habitat,col = cols[c(2:5,3)])
\end{Sinput}
\end{Schunk}
\includegraphics{introduction-habitat-map}

\newpage

\section{Simulating ``agents''}

\paragraph{}

\subsection{Spatial agents}

\subsubsection{Point agents}

\paragraph{}
Agents represented by a single set of coordinates indicating their current position.

\paragraph{}
Use a \texttt{SpatialPointsDataFrame} with additional columns as needed.

\paragraph{Non-mobile point agents}
e.g., plants

\paragraph{Mobile point agents}
e.g., animals use a \texttt{SpatialPointsDataFrame}, with additonal columns for agents' previous \texttt{n} positions, and any other columns such as age, sex, group membership, etc.

\begin{Schunk}
\begin{Sinput}
> N <- 10 # number of agents
> # caribou data vectors
> IDs <- c("Alice", "Bob", "Clark", "Daisy", "Eric",
+          "Franz", "Gabby", "Hayley", "Igor", "Jane")
> sex <- c("female", "male", "male", "female", "male",
+          "male", "female", "female", "male", "female")
> age <- round(rnorm(N, mean=8, sd=3))
> prevX <- runif(N, xmin(habitat)+(ncol(habitat)*0.2), xmax(habitat)-(ncol(habitat)*0.2)) # previous X location
> prevY <- runif(N, ymin(habitat)+(nrow(habitat)*0.2), ymax(habitat)-(nrow(habitat)*0.2)) # previous Y location
> # create the caribou agent object
> caribou <- SpatialPointsDataFrame(coords=cbind(x=rnorm(N, prevX, ncol(habitat)/20),
+                                                y=rnorm(N, prevY, ncol(habitat)/20)),
+                                   data=data.frame(prevX, prevY, sex, age))
> row.names(caribou) <- IDs # alternatively, add IDs as column in data.frame above
> heading(SpatialPoints(cbind(x=prevX,y=prevY)),caribou)
\end{Sinput}
\begin{Soutput}
     Alice        Bob      Clark      Daisy       Eric      Franz      Gabby 
 38.474962 273.092383 356.194627 179.753390  76.812899 295.492537   4.745586 
    Hayley       Igor       Jane 
 48.325622 317.810307 201.352977 
\end{Soutput}
\begin{Sinput}
> coordinates(caribou)
\end{Sinput}
\begin{Soutput}
                x          y
Alice   11.621958 -12.614453
Bob     -1.423196 -18.414185
Clark    2.915477 -11.624194
Daisy   23.594324 -15.727886
Eric    11.769808  22.817639
Franz  -12.462282  -7.736398
Gabby  -18.928142  13.721813
Hayley  19.600945  29.487593
Igor    -7.799135  -3.389671
Jane    10.253194  11.948370
\end{Soutput}
\begin{Sinput}
> ## conventional plotting method - agents don't plot properly when it is a raster stack
> #plot(habitat)
> #plot(caribou, add=TRUE)
> 
> # convenient plotting using simPlot
> simPlot(habitat,col = cols[c(2:5,3)])
> simPlot(caribou,on.which.to.plot=c(2,3,5),pch=19,size=unit(0.1,"inches"))
> drawArrows(from = SpatialPoints(cbind(x=prevX,y=prevY)),
+            to = caribou,
+            on.which.to.plot = "DEM")
\end{Sinput}
\end{Schunk}
\includegraphics{introduction-mobile-point-agent}

\section{A simple fire model}

\paragraph{Burn some of the forest}
Using the spread function, we can simulate fires, and subsequent changes to the various map layers
\begin{Schunk}
\begin{Sinput}
> nFires <- 100 # number of agents
> habitat[["Fires"]] <- spread(habitat[[1]],loci=as.integer(sample(1:ncell(habitat),nFires)),
+                              spreadProb = habitat[["Pct_Pin"]]/(maxValue(habitat[["Pct_Pin"]])*5)+0.12,
+                              persistance=0,
+                              mask = NULL,
+                              maxSize = 1e8,
+                              directions = 8,
+                              iterations=1e6,
+                              mergeDuplicates = T)
\end{Sinput}
\end{Schunk}

\paragraph{}

\begin{Schunk}
\begin{Sinput}
> # Show the burning more strongly over abundant pine
> simPlot(habitat[["Pct_Pin"]],col=cols[[3]])
> simPlot(habitat[["Fires"]],add=T,delete.previous=F,col=cols[[1]])
\end{Sinput}
\end{Schunk}
\includegraphics{introduction-fire-overlaid}


\paragraph{}
We can see that the fires tend to be in the Pines because we made it that way, using an arbitrary weighting with pine abundance

\begin{Schunk}
\begin{Sinput}
> # Show the burning more strongly over abundant pine
> fire<-reclassify(habitat[["Fires"]],rcl= cbind(0:1,c(0,100),0:1))
> pine<-reclassify(habitat[["Pct_Pin"]],rcl= cbind(0:9*10,1:10*10,0:9))
> PineByFire<-crosstab(fire,pine,long=T)
> colnames(PineByFire)<-c("fire","pine","freq")
> PineByFire$pine <- as.numeric(as.character(PineByFire$pine))
> summary(glm(freq ~ fire*pine, data=PineByFire,family="poisson"))
\end{Sinput}
\begin{Soutput}
Call:
glm(formula = freq ~ fire * pine, family = "poisson", data = PineByFire)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-44.052  -19.793   -3.616   13.271   45.605  

Coefficients:
             Estimate Std. Error z value Pr(>|z|)    
(Intercept)  7.131459   0.017524  406.95   <2e-16 ***
fire1       -1.688458   0.045608  -37.02   <2e-16 ***
pine        -0.058666   0.003558  -16.49   <2e-16 ***
fire1:pine   0.143608   0.007751   18.53   <2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 12479.2  on 18  degrees of freedom
Residual deviance:  9314.1  on 15  degrees of freedom
AIC: 9468.3

Number of Fisher Scoring iterations: 5
\end{Soutput}
\end{Schunk}

\paragraph{}
Sure enough, there are more fires as the abundance of pine goes up, as seen by the positive interaction term (the negative fire1 term means that there are more pixels without fires than with fires).

\paragraph{Impact some of the forest}
\begin{Schunk}
\begin{Sinput}
>   habitat[["Age"]][habitat[["Fires"]]>0] <- 0
> habitat[["Forest_Cover"]][habitat[["Fires"]]>0] <- 0
> habitat[["HabitatQuality"]][habitat[["Fires"]]>0] <- 0
> habitat[["Pct_Pin"]][habitat[["Fires"]]>0] <- 0
> simPlot(habitat)
\end{Sinput}
\end{Schunk}
\includegraphics{introduction-Fire-impacts-maps}

\section{A simple individual based model (IBM)}

\lipsum

\end{document}
