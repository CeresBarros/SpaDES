---
output: word_document
---
## Succession and Fire

This is a simple fire disturbance and succession model that acts at a fairly coarse scale (250m x 250m pixels). There are several
```{r load_packages}
library(SpaDES)
library(RColorBrewer)
```

```{r load_data, cache=TRUE, eval=TRUE}
rasterOptions(maxmemory=2e9)
downloadRequired = FALSE
interactiveExtent = FALSE

setwd("~")
dir.create("spadesTmp")
setwd(file.path("spadesTmp"))

if(downloadRequired) {

  #46MB file
  fN <- "lcc05.zip"
  download.file("ftp://ftp.ccrs.nrcan.gc.ca/ad/NLCCLandCover/LandcoverCanada2005_250m/LandCoverOfCanada2005_V1_4.zip", fN, mode="wb")
  unzip(fN, files="LCC2005_V1_4a.tif")
  
  # 9MB file
  download.file("ftp://ftp.daac.ornl.gov/data/nacp/NA_TreeAge//data/can_age04_1km.tif",
                "age.tif",mode="wb")
  
}


fileList <- data.frame(files=c("LCC2005_V1_4a.tif",
                               "age.tif"),
                       functions="raster", packages="raster",
                       objectNames=c("lcc05","age"),
                       stringsAsFactors=FALSE)
loadFiles(fileList=fileList)
ext <- extent(-1380607, -345446, 7211410, 7971750) # large central BC 12Million
#ext <- extent(1612240, 1895057, 6756615, 6907451) # small 600k pixels Quebec City Lac St. Jean
#QC.crs = crs("+proj=lcc +lat_1=49 +lat_2=77 +lat_0=0 +lon_0=-71 +x_0=0 +y_0=0
# +ellps=GRS80 +units=m +no_defs")
ext <- extent(-1073154,-987285,7438423,7512480) # small central Sask 100 Thousand

if(interactiveExtent) {
  dev(4)
  plot(lcc05)
  ext <- drawExtent()
}
```

```{r crop_reproject_data, eval=TRUE, echo=TRUE, cache=TRUE}
vegMapLcc <- crop(lcc05,ext)
if(ncell(vegMapLcc)>1e6) beginCluster(4)

# age will not run with projectRaster directly. Instead, project the vegMap to age, then crop, then project back to vegMap
vegMapLcc.crsAge = projectRaster(vegMapLcc, crs=crs(age))
age.crsAge <- crop(age, vegMapLcc.crsAge)
ageMapInit <- projectRaster(age.crsAge, to=vegMapLcc, method="ngb")
endCluster()
                                   
writeRaster(ageMapInit, filename="ageMapInit.tif", overwrite=TRUE)
```

Here, use the LccToBeaconsReclassify module, and then a simple spades run to implement the module. I keep this separate from the main spades call because it is not required for every run.
```{r reclassify_spadesModule_LccToBeaconsReclassify, eval=TRUE}
times=list(start=0.0, stop=0.1)
parameters <- list(LccToBeaconsReclassify=list(.plotInitialTime=0, .plotInterval=NA,
                                               .saveInitialTime=0, .saveInterval=NA),
                   .progress=list(graphical=NA)
)
modules <- list("LccToBeaconsReclassify")
path <- file.path("~","GitHub","SpaDES","SAMPLE")

mySim <- simInit(times=times, params=parameters, modules=modules, path=path)
dev(4)
print(system.time(mySim <- spades(mySim, debug=FALSE)))
```

The simInit preparation for the main spades run.  This will work for all 4 modules that are refered to, though caribou is blocked out.

```{r prepare_simInit, eval=TRUE}
times=list(start=0.0, stop=100)
parameters <- list(.globals=list(burnStats="nPixelsBurned"),
                   .progress=list(.graphical=TRUE, .progressInterval=2),
                   #.loadFileList=fileList,
                   forestSuccession=list(returnInterval=1, startTime=0,
                                   .plotInitialTime=1, .plotInterval=1),
                   forestAge=list(returnInterval=1, startTime=0.5,
                                        .plotInitialTime=1, .plotInterval=1),
                   fireSpreadLcc=list(nFires= 3, #spreadprob=0.23,
                                     its=1e6, drought=1.4, 
                                      persistprob=0, returnInterval=1, startTime=1,
                                     .plotInitialTime=1, .plotInterval=1)
#                   caribouMovementLcc=list(N=1e2, moveInterval=1, startTime=0,
#                                        .plotInitialTime=1.01, .plotInterval=1)
)

#modules <- list("forestSuccession", "forestAge", "fireSpreadLcc", "caribouMovementLcc")
modules <- list("forestSuccession", "forestAge", "fireSpreadLcc")
path <- file.path("~","GitHub","SpaDES","SAMPLE")
```

Run simInit and spades.
```{r run_spades, eval=TRUE}
mySim <- simInit(times=times, params=parameters, modules=modules, path=path)
dev(4)

rm(nPixelsBurned)

print(system.time(mySim <- spades(mySim, debug=FALSE)))

if("fireSpreadLcc" %in% simModulesLoaded(mySim))  {
  dev(5); par(mfrow=c(2,2))
  hist(nPixelsBurned/6.25, xlab="Hectares",main=paste0("Hectares burned"))
  hist(vegMap, col = getColors(vegMap)$layer)
  hist(sort(getValues(vegMapInit)), col = getColors(vegMapInit)$layer)
  }
#dev.off()
```

```{r plotting, fig=TRUE, eval=TRUE, fig.width=7, fig.height=4}
Plot(vegMapInit, vegMap, new=TRUE, visualSqueeze = 0.65)
```
